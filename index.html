<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>SanchitFlix - Client Side</title>
    <link rel="icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Crect width='100' height='100' rx='20' fill='%23141414'/%3E%3Ctext x='50%25' y='50%25' dominant-baseline='central' text-anchor='middle' font-size='80' font-weight='900' fill='%23E50914' font-family='Arial, sans-serif'%3ES%3C/text%3E%3C/svg%3E">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;900&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary-gradient: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            --secondary-gradient: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            --bg-primary: #ffffff;
            --bg-secondary: #f4f5f7;
            --card-bg: #ffffff;
            --text-primary: #18181b;
            --text-secondary: #52525b;
            --border-color: #e4e4e7;
            --accent-color: #667eea;
            --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
            --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -2px rgba(0, 0, 0, 0.1);
            --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -4px rgba(0, 0, 0, 0.1);
        }

        body.theme-dark {
            --bg-primary: #0a0a0a;
            --bg-secondary: #161a23;
            --card-bg: #1e2433;
            --text-primary: #f8f8f8;
            --text-secondary: #a0a0a0;
            --border-color: rgba(255, 255, 255, 0.1);
            --accent-color: #764ba2;
            --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.2);
            --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.4), 0 2px 4px -2px rgba(0, 0, 0, 0.4);
            --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.4), 0 4px 6px -4px rgba(0, 0, 0, 0.4);
        }
        
        @media (prefers-color-scheme: dark) {
            body:not(.theme-light) {
                --bg-primary: #0a0a0a;
                --bg-secondary: #161a23;
                --card-bg: #1e2433;
                --text-primary: #f8f8f8;
                --text-secondary: #a0a0a0;
                --border-color: rgba(255, 255, 255, 0.1);
                --accent-color: #764ba2;
            }
        }

        * { margin:0; padding:0; box-sizing:border-box; font-family: 'Inter', system-ui, sans-serif; }
        html { scroll-behavior: smooth; }

        body {
            background: var(--bg-secondary);
            color: var(--text-primary);
            max-width: 480px;
            margin: 0 auto;
            overflow-x: hidden;
            -webkit-font-smoothing: antialiased;
            padding-bottom: 70px;
            min-height: 100vh;
        }
        
        @media (min-width: 1024px) {
            body {
                margin: 2rem auto;
                border-radius: 24px;
                box-shadow: 0 25px 50px -12px rgba(0,0,0,0.25);
                height: calc(100vh - 4rem);
                overflow-y: auto;
            }
            .header { border-radius: 24px 24px 0 0; }
            .bottom-nav { border-radius: 0 0 24px 24px; }
        }

        /* Loading */
        .loading-screen { position:fixed; inset:0; display:flex; flex-direction:column; align-items:center; justify-content:center; background:var(--bg-primary); z-index:2000; max-width: 480px; margin: 0 auto; }
        .loading-logo { font-size:52px; font-weight:900; background: var(--primary-gradient); -webkit-background-clip: text; background-clip: text; color: transparent; margin-bottom:20px; animation: dreamPulse 2s infinite; }
        .loading-text { color:var(--text-secondary); font-size:18px; letter-spacing: 2px; }
        @keyframes dreamPulse { 0%, 100% { transform: scale(1); } 50% { transform: scale(1.1); } }

        /* Header */
        .header {
            background: rgba(var(--bg-primary-rgb, 255, 255, 255), 0.8);
            backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px);
            padding: 16px; display: flex; gap: 12px; align-items: center;
            position: sticky; top: 0; z-index: 90;
            border-bottom: 1px solid var(--border-color);
            box-shadow: var(--shadow-md);
        }
        .logo { font-size:24px; font-weight:900; background: var(--primary-gradient); -webkit-background-clip: text; background-clip: text; color: transparent; letter-spacing: -1px; }
        .provider-name-display { font-size: 12px; font-weight: 700; background: var(--secondary-gradient); -webkit-background-clip: text; background-clip: text; color: transparent; padding: 4px 10px; border-radius: 20px; border: 1px solid var(--border-color); margin-left: 8px;}
        .header-actions { margin-left: auto; display: flex; gap: 16px; }
        .header-icon-btn { background: none; border: 0; color: var(--text-secondary); font-size: 20px; cursor: pointer; transition: 0.3s; }
        .header-icon-btn:hover { color: var(--text-primary); transform: scale(1.1); }

        /* Slider */
        .slider-wrapper { position: relative; border-radius: 24px; box-shadow: var(--shadow-lg); margin-bottom: 24px; background: var(--card-bg); overflow: hidden; }
        .slider-container { width: 100%; height: 240px; overflow-x: auto; scroll-snap-type: x mandatory; scrollbar-width: none; display: flex; }
        .slider-container::-webkit-scrollbar { display: none; }
        .slide { min-width: 100%; height: 100%; position: relative; scroll-snap-align: start; }
        .slide img { width: 100%; height: 100%; object-fit: cover; filter: brightness(0.7); }
        .slide-overlay { position: absolute; inset: 0; padding: 24px; display: flex; flex-direction: column; justify-content: flex-end; background: linear-gradient(180deg, transparent 0%, rgba(0,0,0,0.8) 70%, #000 100%); }
        .slide-title { font-size: 22px; font-weight: 900; color: white; text-shadow: 0 2px 10px rgba(0,0,0,0.5); margin-bottom: 8px;}
        
        /* Grid & Cards */
        .category-section { margin-bottom: 32px; }
        .category-header { display: flex; justify-content: space-between; align-items: center; padding: 0 16px 12px; }
        .category-title { font-size: 20px; font-weight: 900; color: var(--text-primary); padding-left: 10px; border-left: 4px solid var(--accent-color); }
        .content-slider { display: flex; overflow-x: auto; gap: 16px; padding: 8px 16px 12px; scrollbar-width: none; }
        .content-slider::-webkit-scrollbar { display: none; }
        .grid-item { flex: 0 0 calc(33.33% - 12px); cursor: pointer; transition: transform 0.3s; }
        .grid-item:hover { transform: translateY(-5px); }
        .content-card { border-radius: 12px; overflow: hidden; position: relative; background: var(--card-bg); box-shadow: var(--shadow-md); aspect-ratio: 2/3; }
        .content-card img { width: 100%; height: 100%; object-fit: cover; }
        .content-caption { font-size: 13px; color: var(--text-secondary); text-align: center; margin-top: 8px; font-weight: 600; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }

        /* Detail Page */
        .detail-page { padding-top: 0; }
        .detail-backdrop { width: 100%; height: 260px; position: relative; }
        .detail-backdrop img { width: 100%; height: 100%; object-fit: cover; filter: brightness(0.6); }
        .detail-content { padding: 16px; display: flex; gap: 16px; margin-top: -80px; position: relative; z-index: 10; }
        .detail-poster { width: 120px; height: 180px; border-radius: 12px; overflow: hidden; box-shadow: var(--shadow-lg); flex-shrink: 0; border: 2px solid white;}
        .detail-poster img { width: 100%; height: 100%; object-fit: cover; }
        .detail-info { flex: 1; padding-top: 85px; } /* Pushed down to clear backdrop overlap */
        .detail-title { font-size: 20px; font-weight: 900; color: var(--text-primary); margin-bottom: 8px; line-height: 1.2; }
        .detail-meta { font-size: 13px; color: var(--text-secondary); display: flex; gap: 10px; }
        #detail-storyline { background: var(--bg-secondary); padding: 16px; border-radius: 16px; margin: 16px 0; color: var(--text-secondary); font-size: 15px; line-height: 1.6; }
        
        .link-list { display: flex; flex-direction: column; gap: 10px; margin-bottom: 30px;}
        .link-btn {
            background: var(--bg-secondary); border: 1px solid var(--border-color);
            color: var(--text-primary); padding: 14px; border-radius: 12px;
            font-weight: 600; text-align: left; display: flex; justify-content: space-between;
            align-items: center; cursor: pointer; transition: 0.2s; text-decoration: none;
        }
        .link-btn:hover { border-color: var(--accent-color); background: var(--card-bg); }
        .season-select { width: 100%; padding: 12px; border-radius: 12px; border: 1px solid var(--border-color); background: var(--bg-secondary); color: var(--text-primary); font-weight: 600; margin-bottom: 12px; }

        /* Provider Menu */
        #side-menu-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.5); z-index: 2000; display: none; backdrop-filter: blur(5px); }
        #side-menu-panel { position: fixed; top: 0; left: 0; bottom: 0; width: 80%; max-width: 280px; background: var(--bg-secondary); padding: 20px; transform: translateX(-100%); transition: transform 0.3s ease; display: flex; flex-direction: column; z-index: 2001; box-shadow: var(--shadow-lg); }
        body.menu-open #side-menu-overlay { display: block; }
        body.menu-open #side-menu-panel { transform: translateX(0); }
        .provider-btn { width: 100%; padding: 14px; background: var(--card-bg); border: 1px solid var(--border-color); margin-bottom: 10px; border-radius: 12px; text-align: left; font-weight: 600; color: var(--text-secondary); cursor: pointer; }
        .provider-btn.active { background: var(--primary-gradient); color: white; border: none; }

        /* Modal */
        #stream-modal { position: fixed; inset: 0; background: rgba(0,0,0,0.8); z-index: 3000; display: none; justify-content: center; align-items: center; backdrop-filter: blur(5px); }
        .stream-modal-content { background: var(--bg-primary); padding: 24px; border-radius: 20px; width: 90%; max-width: 400px; max-height: 80vh; overflow-y: auto; position: relative; }
        .stream-item { display: block; padding: 12px; border-bottom: 1px solid var(--border-color); color: var(--text-primary); text-decoration: none; font-weight: 600; }
        .stream-item:last-child { border-bottom: none; }
        .stream-item:hover { background: var(--bg-secondary); color: var(--accent-color); }

        /* Bottom Nav */
        .bottom-nav { position: fixed; bottom: 0; left: 0; right: 0; max-width: 480px; margin: 0 auto; background: var(--bg-primary); border-top: 1px solid var(--border-color); display: flex; justify-content: space-around; padding: 12px 0; z-index: 100; }
        .nav-item { flex: 1; text-align: center; color: var(--text-secondary); text-decoration: none; font-size: 11px; display: flex; flex-direction: column; gap: 4px; }
        .nav-item i { font-size: 20px; }
        .nav-item.active { color: var(--accent-color); }

        .page { display: none; min-height: 100vh; }
        #home-page { display: block; }
    </style>
</head>
<body class="theme-dark">

    <!-- Loading Screen -->
    <div id="loading-screen" class="loading-screen">
        <div class="loading-logo">SanchitFlix</div>
        <div class="loading-text">Initializing Core...</div>
    </div>

    <!-- Provider Selection (Side Menu) -->
    <div id="side-menu-overlay"></div>
    <div id="side-menu-panel">
        <h2 style="margin-bottom: 20px; font-weight: 900; background: var(--primary-gradient); -webkit-background-clip: text; color: transparent;">Select Source</h2>
        <div id="provider-list"></div>
    </div>

    <!-- Stream Modal -->
    <div id="stream-modal">
        <div class="stream-modal-content">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
                <h3 style="margin: 0;">Select Stream</h3>
                <button onclick="closeStreamModal()" style="background: none; border: none; font-size: 20px; color: var(--text-secondary); cursor: pointer;"><i class="fas fa-times"></i></button>
            </div>
            <div id="stream-list"></div>
        </div>
    </div>

    <!-- MAIN PAGES -->

    <!-- 1. Home Page -->
    <div id="home-page" class="page">
        <div class="header">
            <button id="menu-btn" class="header-icon-btn"><i class="fas fa-bars"></i></button>
            <div class="logo">SanchitFlix</div>
            <span id="provider-badge" class="provider-name-display">Vega</span>
            <div class="header-actions">
                <button onclick="toggleTheme()" class="header-icon-btn"><i class="fas fa-moon"></i></button>
                <button onclick="showPage('search-page')" class="header-icon-btn"><i class="fas fa-search"></i></button>
            </div>
        </div>

        <div class="slider-wrapper">
            <div id="slider-container" class="slider-container"></div>
        </div>

        <div id="home-content"></div>
    </div>

    <!-- 2. Detail Page -->
    <div id="detail-page" class="page">
        <div class="header" style="position: absolute; background: transparent; border: none; box-shadow: none;">
            <button onclick="goBack()" class="header-icon-btn" style="background: rgba(0,0,0,0.3); color: white; width: 36px; height: 36px; border-radius: 50%;"><i class="fas fa-arrow-left"></i></button>
        </div>
        <div id="detail-backdrop" class="detail-backdrop"></div>
        <div class="detail-content">
            <div id="detail-poster" class="detail-poster"></div>
            <div class="detail-info">
                <h1 id="detail-title" class="detail-title"></h1>
                <div id="detail-meta" class="detail-meta"></div>
            </div>
        </div>
        <div style="padding: 0 16px;">
            <div id="detail-storyline"></div>
            <h3 style="margin: 24px 0 12px; font-size: 18px; font-weight: 800;">Download / Watch</h3>
            <div id="detail-links" class="link-list"></div>
        </div>
    </div>

    <!-- 3. Search Page -->
    <div id="search-page" class="page">
        <div class="header">
            <button onclick="goBack()" class="header-icon-btn"><i class="fas fa-arrow-left"></i></button>
            <div class="logo">Search</div>
        </div>
        <div style="padding: 16px;">
            <input type="text" id="search-input" placeholder="Search movies..." style="width: 100%; padding: 14px; border-radius: 30px; border: 1px solid var(--border-color); background: var(--bg-secondary); color: var(--text-primary); font-size: 16px; outline: none;">
        </div>
        <div id="search-results" class="category-grid" style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 12px; padding: 0 16px;"></div>
    </div>

    <!-- Bottom Nav -->
    <nav class="bottom-nav">
        <a href="#" onclick="showPage('home-page')" class="nav-item active"><i class="fas fa-home"></i><span>Home</span></a>
        <a href="#" class="nav-item"><i class="fas fa-heart"></i><span>Favorites</span></a>
        <a href="#" class="nav-item"><i class="fas fa-cog"></i><span>Settings</span></a>
    </nav>

    <!-- LOGIC SCRIPT -->
    <script>
        /* ================= CONFIGURATION ================= */
        // Using AllOrigins as a CORS proxy since we are completely client-side
        const CORS_PROXY = "https://api.allorigins.win/raw?url=";
        let activeProviderId = 'vega';
        let pageHistory = [];

        /* ================= UTILITIES ================= */
        const $ = (sel) => document.querySelector(sel);
        const $$ = (sel) => document.querySelectorAll(sel);
        
        const fetchHtml = async (url) => {
            try {
                // If url is already proxied or relative, handle it
                const targetUrl = url.startsWith('http') ? url : ''; 
                if (!targetUrl) return null;

                const response = await fetch(CORS_PROXY + encodeURIComponent(targetUrl));
                const text = await response.text();
                const parser = new DOMParser();
                return parser.parseFromString(text, 'text/html');
            } catch (e) {
                console.error("Fetch Error:", e);
                return null;
            }
        };

        const showLoading = (show) => $('#loading-screen').style.display = show ? 'flex' : 'none';

        /* ================= PROVIDER LOGIC (Client-Side) ================= */
        
        // --- 1. VegaMovies Provider (Ported to JS) ---
        const VegaProvider = {
            baseUrl: "https://vegamovies.ist", // Base URL might change, update if needed
            
            catalog: [
                { title: "Latest Updates", filter: "" },
                { title: "Netflix", filter: "/web-series/netflix" },
                { title: "Amazon Prime", filter: "/web-series/amazon-prime-video" },
                { title: "4K Movies", filter: "/movies-by-quality/2160p" }
            ],

            async getPosts(filter, page = 1) {
                const url = filter ? `${this.baseUrl}${filter}/page/${page}/` : `${this.baseUrl}/page/${page}/`;
                const doc = await fetchHtml(url);
                if (!doc) return [];

                const posts = [];
                const articles = doc.querySelectorAll(".blog-items article, .post-item");
                
                articles.forEach(el => {
                    const linkEl = el.querySelector("a");
                    const imgEl = el.querySelector("img");
                    if (linkEl && imgEl) {
                        let title = linkEl.getAttribute("title") || linkEl.textContent;
                        title = title.replace("Download", "").trim();
                        // Extract cleaner title
                        const match = title.match(/^(.*?)\s*\((\d{4})\)/);
                        if (match) title = match[0];

                        posts.push({
                            title: title,
                            link: linkEl.getAttribute("href"),
                            image: imgEl.getAttribute("data-src") || imgEl.getAttribute("src")
                        });
                    }
                });
                return posts;
            },

            async getSearch(query) {
                const url = `${this.baseUrl}/?s=${encodeURIComponent(query)}`;
                const doc = await fetchHtml(url);
                if (!doc) return [];
                
                const posts = [];
                // Vega search results structure
                const articles = doc.querySelectorAll("article.post-item, article");
                articles.forEach(el => {
                    const linkEl = el.querySelector("a");
                    const imgEl = el.querySelector("img");
                    if (linkEl && imgEl) {
                        posts.push({
                            title: (linkEl.getAttribute("title") || "").replace("Download", "").trim(),
                            link: linkEl.getAttribute("href"),
                            image: imgEl.getAttribute("data-src") || imgEl.getAttribute("src")
                        });
                    }
                });
                return posts;
            },

            async getMeta(link) {
                const doc = await fetchHtml(link);
                if (!doc) return null;

                const content = doc.querySelector(".entry-content, .post-inner");
                if (!content) return null;

                // Extract Info
                const title = doc.querySelector("h1.entry-title")?.textContent.replace("Download", "").trim();
                let image = content.querySelector("img")?.getAttribute("src");
                
                // Synopsis fallback
                let synopsis = "";
                const pTags = content.querySelectorAll("p");
                for (let p of pTags) {
                    if (p.textContent.length > 50 && !p.textContent.includes("Download")) {
                        synopsis = p.textContent;
                        break;
                    }
                }

                // Determine Type
                const isSeries = title.includes("Season") || content.textContent.includes("Episode");

                // Extract Links
                const links = [];
                
                if (isSeries) {
                    // Series Logic: Find V-Cloud/G-Drive Links per header
                    const headers = content.querySelectorAll("h3, h4, h5");
                    headers.forEach(header => {
                        const label = header.textContent.trim();
                        // Naive check for quality headers like "720p" or "Season 1"
                        if (label.includes("p") || label.includes("Season")) {
                            // Look for next V-Cloud/Download button
                            let next = header.nextElementSibling;
                            while(next && next.tagName !== 'H3' && next.tagName !== 'H4') {
                                const btn = next.querySelector("a[href*='vcloud'], a[href*='robot'], a.dwd-button");
                                if (btn) {
                                    links.push({
                                        title: label,
                                        link: btn.getAttribute("href"),
                                        type: "series" // Needs extraction page
                                    });
                                    break; // Found one for this header
                                }
                                next = next.nextElementSibling;
                            }
                        }
                    });
                } else {
                    // Movie Logic
                    const btns = content.querySelectorAll("a.dwd-button, a[href*='vcloud'], a[href*='archives']");
                    btns.forEach(btn => {
                        const txt = btn.textContent.trim();
                        if (txt.includes("Download") || txt.includes("Link")) {
                            // Try to find the quality label from previous element
                            let prev = btn.parentElement.previousElementSibling;
                            let quality = "Unknown Quality";
                            if (prev && (prev.tagName === 'H3' || prev.tagName === 'H5')) {
                                quality = prev.textContent.trim();
                            }
                            
                            links.push({
                                title: quality + " - " + txt,
                                link: btn.getAttribute("href"),
                                type: "movie"
                            });
                        }
                    });
                }

                return { title, image, synopsis, type: isSeries ? "series" : "movie", links };
            },

            async getEpisodes(url) {
                // For series, Vega usually redirects to a page with episode lists
                const doc = await fetchHtml(url);
                if (!doc) return [];
                
                const episodes = [];
                const headers = doc.querySelectorAll("h4, h5");
                
                headers.forEach(h => {
                    const title = h.textContent.trim();
                    // Look for link in next p
                    const link = h.nextElementSibling?.querySelector("a")?.getAttribute("href");
                    if (link) {
                        episodes.push({ title, link });
                    }
                });
                
                // Fallback: Check all buttons if headers fail
                if (episodes.length === 0) {
                    const buttons = doc.querySelectorAll("a.dwd-button, .btn-outline");
                    buttons.forEach(btn => {
                        episodes.push({ title: btn.textContent.trim(), link: btn.getAttribute("href") });
                    });
                }

                return episodes;
            },

            async getStream(url) {
                // Vega often leads to V-Cloud/HubCloud. We need to scrape that landing page.
                // Note: Actual streaming extraction often requires token generation which is hard purely client side.
                // We will try to find the "Download" or "Instant" link on the destination.
                
                const doc = await fetchHtml(url);
                if (!doc) return null;

                // Simple Extractor: Look for "HubCloud" or "Drive" links
                // This is a simplified version. Real logic is complex.
                const hubLink = doc.querySelector("a.btn-success")?.getAttribute("href");
                if (hubLink) return hubLink;

                const directLink = doc.querySelector("a[href$='.mkv'], a[href$='.mp4']");
                if (directLink) return directLink.getAttribute("href");

                // If it's a V-Cloud page, return the url itself for the user to visit
                return url; 
            }
        };

        // --- 2. MoviesMod Provider ---
        const ModProvider = {
            baseUrl: "https://moviesmod.vip", // Check actual domain
            catalog: [
                { title: "Latest", filter: "" },
                { title: "Netflix", filter: "/ott/netflix" },
                { title: "Amazon Prime", filter: "/ott/amazon-prime-video" }
            ],
            async getPosts(filter, page=1) {
                const url = filter ? `${this.baseUrl}${filter}/page/${page}/` : `${this.baseUrl}/page/${page}/`;
                const doc = await fetchHtml(url);
                if(!doc) return [];
                const posts = [];
                doc.querySelectorAll("article").forEach(el => {
                    const a = el.querySelector("a");
                    const img = el.querySelector("img");
                    if(a && img) {
                        posts.push({
                            title: a.getAttribute("title").replace("Download", "").trim(),
                            link: a.getAttribute("href"),
                            image: img.getAttribute("src")
                        });
                    }
                });
                return posts;
            },
            async getMeta(link) {
                const doc = await fetchHtml(link);
                if(!doc) return null;
                
                const content = doc.querySelector(".thecontent, .entry-content");
                const title = doc.querySelector("h1")?.textContent.replace("Download", "").trim();
                const image = content.querySelector("img")?.getAttribute("src");
                const synopsis = content.querySelectorAll("p")[2]?.textContent || ""; // Approximation
                
                const links = [];
                // MoviesMod usually has "Download Links" buttons
                content.querySelectorAll("a[href*='links'], a.maxbutton").forEach(btn => {
                    links.push({
                        title: btn.textContent.trim() || "Download Link",
                        link: btn.getAttribute("href"),
                        type: "series" // Often treats everything as a pack/series link structure
                    });
                });

                return { title, image, synopsis, type: "series", links };
            }
        };

        // --- Provider Manager ---
        const Providers = {
            'vega': VegaProvider,
            'mod': ModProvider
        };

        /* ================= APP LOGIC ================= */

        function getActiveProvider() {
            return Providers[activeProviderId];
        }

        async function loadHome() {
            showLoading(true);
            const provider = getActiveProvider();
            
            // Set Provider Badge
            $('#provider-badge').textContent = activeProviderId.toUpperCase();

            // Load Slider (Latest Posts)
            try {
                const latest = await provider.getPosts("", 1);
                renderSlider(latest.slice(0, 5));
                
                // Load Catalog Sections
                const contentDiv = $('#home-content');
                contentDiv.innerHTML = ''; // Clear
                
                for (let section of provider.catalog) {
                    const secDiv = document.createElement('div');
                    secDiv.className = 'category-section';
                    secDiv.innerHTML = `<div class="category-header"><h2 class="category-title">${section.title}</h2></div><div class="content-slider" id="cat-${section.title.replace(/\s/g,'')}"></div>`;
                    contentDiv.appendChild(secDiv);
                    
                    // Fetch content for this section
                    // Don't await loop to load parallel
                    provider.getPosts(section.filter, 1).then(posts => {
                        const slider = document.getElementById(`cat-${section.title.replace(/\s/g,'')}`);
                        renderGrid(posts, slider);
                    });
                }
            } catch (e) {
                alert("Error loading provider. Try another.");
            }
            showLoading(false);
        }

        function renderSlider(posts) {
            const container = $('#slider-container');
            container.innerHTML = '';
            posts.forEach(post => {
                const slide = document.createElement('div');
                slide.className = 'slide';
                slide.onclick = () => openDetail(post.link);
                slide.innerHTML = `
                    <img src="${post.image}" alt="${post.title}">
                    <div class="slide-overlay">
                        <div class="slide-title">${post.title}</div>
                    </div>
                `;
                container.appendChild(slide);
            });
        }

        function renderGrid(posts, container) {
            container.innerHTML = '';
            posts.forEach(post => {
                const card = document.createElement('div');
                card.className = 'grid-item';
                card.onclick = () => openDetail(post.link);
                card.innerHTML = `
                    <div class="content-card">
                        <img src="${post.image}" loading="lazy">
                    </div>
                    <p class="content-caption">${post.title}</p>
                `;
                container.appendChild(card);
            });
        }

        async function openDetail(link) {
            showLoading(true);
            const provider = getActiveProvider();
            const meta = await provider.getMeta(link); // Need to implement getMeta
            if (!meta) {
                showLoading(false);
                alert("Failed to load details.");
                return;
            }

            // Populate UI
            $('#detail-title').textContent = meta.title;
            $('#detail-poster').innerHTML = `<img src="${meta.image}">`;
            $('#detail-backdrop').innerHTML = `<img src="${meta.image}">`;
            $('#detail-storyline').textContent = meta.synopsis || "No description available.";
            
            const linkList = $('#detail-links');
            linkList.innerHTML = '';

            // Handle Links
            if (meta.type === 'series') {
                // Show links as buttons that open episode list
                meta.links.forEach((l, idx) => {
                    const btn = document.createElement('button');
                    btn.className = 'link-btn';
                    btn.innerHTML = `<span>${l.title}</span><i class="fas fa-chevron-right"></i>`;
                    btn.onclick = () => loadEpisodes(l.link);
                    linkList.appendChild(btn);
                });
            } else {
                // Movies
                meta.links.forEach(l => {
                    const btn = document.createElement('button');
                    btn.className = 'link-btn';
                    btn.innerHTML = `<span>${l.title}</span><i class="fas fa-play"></i>`;
                    btn.onclick = () => window.open(l.link, '_blank'); // Direct open for now
                    linkList.appendChild(btn);
                });
            }

            showPage('detail-page');
            showLoading(false);
        }

        async function loadEpisodes(url) {
            showLoading(true);
            const provider = getActiveProvider();
            
            // If the provider is Vega, getEpisodes logic handles scraping the intermediate page
            let episodes = [];
            if (provider.getEpisodes) {
                episodes = await provider.getEpisodes(url);
            }

            // Show in Modal
            const list = $('#stream-list');
            list.innerHTML = '';
            
            if (episodes.length === 0) {
                list.innerHTML = '<p style="text-align:center">No direct episodes found. Opening link...</p>';
                setTimeout(() => window.open(url, '_blank'), 1500);
            } else {
                episodes.forEach(ep => {
                    const btn = document.createElement('a');
                    btn.className = 'stream-item';
                    btn.textContent = ep.title;
                    btn.href = ep.link; // Direct link
                    btn.target = "_blank"; // Open in new tab because of CORS/Sandbox issues with players
                    list.appendChild(btn);
                });
            }
            
            $('#stream-modal').style.display = 'flex';
            showLoading(false);
        }

        async function performSearch() {
            const query = $('#search-input').value;
            if(!query) return;
            
            showLoading(true);
            const provider = getActiveProvider();
            const results = await provider.getSearch(query);
            
            const container = $('#search-results');
            container.innerHTML = '';
            
            if(results.length === 0) {
                container.innerHTML = '<p style="grid-column:1/-1; text-align:center">No results found.</p>';
            } else {
                results.forEach(post => {
                    const card = document.createElement('div');
                    card.className = 'grid-item';
                    card.onclick = () => openDetail(post.link);
                    card.innerHTML = `
                        <div class="content-card">
                            <img src="${post.image}" loading="lazy">
                        </div>
                        <p class="content-caption">${post.title}</p>
                    `;
                    container.appendChild(card);
                });
            }
            showLoading(false);
        }

        /* ================= UI HELPERS ================= */
        
        function showPage(pageId) {
            if(pageId !== 'home-page' && !pageHistory.includes(pageId)) {
                // simple history implementation
            }
            $$('.page').forEach(p => p.style.display = 'none');
            $('#' + pageId).style.display = 'block';
            window.scrollTo(0,0);
        }

        function goBack() {
            showPage('home-page');
        }

        function toggleTheme() {
            document.body.classList.toggle('theme-light');
            document.body.classList.toggle('theme-dark');
        }

        // Side Menu Logic
        $('#menu-btn').onclick = () => document.body.classList.add('menu-open');
        $('#side-menu-overlay').onclick = () => document.body.classList.remove('menu-open');

        // Populate Provider List
        const pList = $('#provider-list');
        Object.keys(Providers).forEach(key => {
            const btn = document.createElement('button');
            btn.className = `provider-btn ${activeProviderId === key ? 'active' : ''}`;
            btn.textContent = key === 'vega' ? 'VegaMovies' : 'MoviesMod';
            btn.onclick = () => {
                activeProviderId = key;
                document.body.classList.remove('menu-open');
                loadHome();
                // Update UI
                $$('.provider-btn').forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
            };
            pList.appendChild(btn);
        });

        function closeStreamModal() {
            $('#stream-modal').style.display = 'none';
        }

        // Search Input Listener
        $('#search-input').addEventListener('keypress', (e) => {
            if(e.key === 'Enter') performSearch();
        });

        /* ================= INITIALIZATION ================= */
        window.onload = () => {
            loadHome();
        };

    </script>
</body>
</html>
