<!DOCTYPE html>
<html lang="en" class="scroll-smooth">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>SanchitFlix</title>
    <meta name="theme-color" content="#111827" />

    <!-- NEW GEMINI-STYLE LOGO / FAVICON -->
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Cdefs%3E%3ClinearGradient id='geminiGradient' x1='0%25' y1='0%25' x2='100%25' y2='100%25'%3E%3Cstop offset='0%25' stop-color='%2389f7fe'/%3E%3Cstop offset='50%25' stop-color='%2366a6ff'/%3E%3Cstop offset='100%25' stop-color='%23a382ff'/%3E%3C/linearGradient%3E%3C/defs%3E%3Crect width='100' height='100' rx='20' fill='%231f2937'/%3E%3Cpath fill='url(%23geminiGradient)' d='M50 10 L58 42 L90 50 L58 58 L50 90 L42 58 L10 50 L42 42 Z'/%3E%3C/svg%3E" />
    
    <!-- PWA MANIFEST -->
    <link rel="manifest" href="manifest.json">

    <!-- Tailwind CSS (with custom configuration) -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: { sans: ["Poppins", "ui-sans-serif", "system-ui"] },
                    colors: {
                        // New, sleeker color palette
                        background: '#111827', // dark gray-blue
                        surface: '#1F2937',    // lighter gray-blue for cards
                        primary: '#E5E7EB',     // light gray for primary text
                        secondary: '#9CA3AF',   // medium gray for secondary text
                        accent: {
                            light: '#22d3ee', // light cyan
                            DEFAULT: '#06b6d4', // cyan-500
                            dark: '#0891b2',  // cyan-600
                        },
                    },
                    boxShadow: {
                        // Updated glow effects to use the new accent color
                        glow: "0 10px 30px -10px rgba(0,0,0,0.5)",
                        accentGlow: "0 0 0 2px rgba(6, 182, 212, 0.3), 0 5px 20px rgba(6, 182, 212, 0.2)",
                    },
                    keyframes: {
                        shimmer: {
                            "0%": { backgroundPosition: "-450px 0" },
                            "100%": { backgroundPosition: "450px 0" },
                        },
                        fadeUp: {
                            "0%": { opacity: 0, transform: "translateY(10px)" },
                            "100%": { opacity: 1, transform: "translateY(0)" },
                        },
                    },
                    animation: {
                        shimmer: "shimmer 1.5s linear infinite",
                        fadeUp: "fadeUp .5s ease-out forwards",
                    },
                    backgroundImage: {
                        // A subtle background glow from the top
                        'soft-glow': "radial-gradient(circle 1000px at 50% -30%, rgba(6, 182, 212, 0.1), transparent 60%)",
                    },
                },
            },
        };
    </script>

    <!-- Fonts & Icons -->
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet" />
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" rel="stylesheet" />

    <style>
        :root {
            color-scheme: dark;
        }
        body {
            background-color: #111827;
            background-image: radial-gradient(circle 1000px at 50% -30%, rgba(6, 182, 212, 0.1), transparent 60%);
            min-height: 100vh;
            overflow-x: hidden;
            color: #E5E7EB;
        }
        /* Removed .glass, using solid surfaces now */
        .ring-focus:focus { box-shadow: 0 0 0 3px rgba(6, 182, 212, .4); outline: none; }
        .skeleton { background: linear-gradient(90deg, rgba(255,255,255,.06) 25%, rgba(255,255,255,.10) 37%, rgba(255,255,255,.06) 63%); background-size: 450px 100%; }
        .clamp-2 { display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; }
        .clamp-3 { display: -webkit-box; -webkit-line-clamp: 3; -webkit-box-orient: vertical; overflow: hidden; }

        /* New button styles */
        .accent-btn {
            background: linear-gradient(to right, #22d3ee, #06b6d4);
            box-shadow: 0 4px 15px -5px rgba(6, 182, 212, 0.5);
            transition: all 0.2s ease-in-out;
        }
        .accent-btn:hover {
            opacity: 0.9;
            box-shadow: 0 6px 20px -5px rgba(6, 182, 212, 0.6);
            transform: translateY(-1px);
        }

        .tab-button {
            transition: all 0.2s ease-in-out;
            font-weight: 600;
            border-bottom: 2px solid transparent;
            color: #9CA3AF; /* secondary text */
            padding: 0.75rem 0.5rem;
        }
        .tab-button.active {
            color: #06b6d4; /* accent */
            border-bottom-color: #06b6d4;
        }
        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(17, 24, 39, 0.8);
            display: flex; justify-content: center; align-items: center;
            z-index: 50; backdrop-filter: blur(8px);
        }
        .modal-content img { border-radius: 0.75rem; box-shadow: 0 25px 50px -12px rgba(0,0,0,0.5); }
        .modal-close {
            position: absolute; top: 1rem; right: 1rem; z-index: 60;
            background: rgba(31, 41, 55, 0.7); border: 1px solid rgba(255,255,255,0.1);
            backdrop-filter: blur(10px);
        }
    </style>
</head>
<body class="font-sans selection:bg-accent/30 min-h-screen">
    <!-- NAVBAR -->
    <header class="sticky top-0 z-40 backdrop-blur-lg supports-[backdrop-filter]:bg-background/80 bg-background/90 border-b border-white/10">
        <div class="mx-auto max-w-7xl px-4 sm:px-6 lg:px-8">
            <div class="flex h-16 items-center justify-between">
                <a href="https://real-morpheus.github.io/portfolio" target="_blank" rel="noopener" class="group inline-flex items-center gap-3">
                    <span class="relative grid h-9 w-9 place-items-center rounded-lg bg-surface border border-white/10">
                        <svg class="h-7 w-7" viewBox="0 0 100 100" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <defs>
                                <linearGradient id="geminiGradient" x1="0%" y1="0%" x2="100%" y2="100%">
                                    <stop offset="0%" stop-color="#89f7fe" />
                                    <stop offset="50%" stop-color="#66a6ff" />
                                    <stop offset="100%" stop-color="#a382ff" />
                                </linearGradient>
                            </defs>
                            <path fill="url(#geminiGradient)" d="M50 10 L58 42 L90 50 L58 58 L50 90 L42 58 L10 50 L42 42 Z"/>
                        </svg>
                    </span>
                    <span class="text-lg sm:text-xl font-bold tracking-tight text-primary">SanchitFlix</span>
                </a>

                <div class="flex items-center gap-2">
                    <nav class="hidden md:flex items-center gap-6 text-sm font-medium text-secondary">
                        <a class="hover:text-primary transition" href="#" onclick="fetchMovies(1); event.preventDefault();">Home</a>
                        <a class="hover:text-primary transition" href="https://real-morpheus.github.io/portfolio" target="_blank" rel="noopener">About</a>
                    </nav>
                    <button id="mobile-search-button" class="md:hidden h-10 w-10 grid place-items-center rounded-full text-secondary hover:text-primary hover:bg-surface transition" aria-label="Open search">
                        <i class="fa-solid fa-magnifying-glass"></i>
                    </button>
                </div>
            </div>
        </div>
    </header>

    <!-- HERO -->
    <section class="relative py-12 sm:py-16 lg:py-20">
        <div class="mx-auto max-w-7xl px-4 sm:px-6 lg:px-8">
            <div class="text-center max-w-3xl mx-auto">
                <h1 class="text-3xl sm:text-4xl lg:text-5xl font-extrabold tracking-tighter text-primary">
                    Your Portal to <span class="text-accent">Unlimited</span> Entertainment
                </h1>
                <p class="mt-4 text-base sm:text-lg text-secondary">Instantly find and download your favorite movies and series. Simple, fast, and elegant.</p>

                <!-- Search -->
                <div class="mt-8 max-w-2xl mx-auto">
                    <div class="relative">
                        <i class="fa-solid fa-magnifying-glass absolute left-4 top-1/2 -translate-y-1/2 text-secondary"></i>
                        <input id="search-input" type="text" placeholder="Search for 'The Matrix'..." class="w-full bg-surface border border-white/10 rounded-full h-14 pl-12 pr-36 text-base text-primary placeholder-secondary ring-focus" />
                        <button id="search-button" class="absolute right-2 top-1/2 -translate-y-1/2 inline-flex items-center justify-center gap-2 accent-btn text-gray-900 h-11 px-6 rounded-full font-semibold active:scale-95 transition">
                            <span>Search</span>
                        </button>
                    </div>
                </div>

                <!-- Quick chips -->
                <div class="mt-5 flex flex-wrap gap-2 justify-center" id="quickChips"></div>
            </div>
        </div>
    </section>

    <!-- STATUS TOAST -->
    <div id="toast" class="fixed top-20 left-1/2 -translate-x-1/2 z-50 hidden max-w-[90vw]">
        <div class="bg-surface border border-white/10 rounded-full px-4 py-3 text-sm flex items-center gap-3 shadow-lg">
            <i class="fa-solid fa-circle-info text-accent"></i>
            <span id="toastText" class="truncate"></span>
        </div>
    </div>

    <!-- RESULTS SECTION -->
    <main id="results" class="mx-auto max-w-7xl px-4 sm:px-6 lg:px-8 py-6">
        <div id="resultMetaContainer" class="flex items-center justify-between mb-5">
            <h2 class="text-2xl font-bold">Latest Releases</h2>
            <div class="text-sm text-secondary" id="resultMeta"></div>
        </div>

        <!-- GRID -->
        <div id="movie-list" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 xl:grid-cols-6 gap-4 sm:gap-5"></div>

        <!-- PAGINATION -->
        <div id="pagination-container" class="mt-10 flex flex-wrap justify-center items-center gap-2"></div>

        <!-- SKELETONS -->
        <template id="card-skeleton">
            <div class="bg-surface rounded-lg overflow-hidden border border-white/10">
                <div class="aspect-[2/3] skeleton animate-shimmer"></div>
                <div class="p-3">
                    <div class="h-4 w-3/4 skeleton animate-shimmer rounded"></div>
                    <div class="h-3 w-1/2 mt-2 skeleton animate-shimmer rounded"></div>
                </div>
            </div>
        </template>

        <!-- DETAILS -->
        <section id="movie-details-section" class="hidden mt-6"></section>
    </main>

    <!-- FOOTER -->
    <footer id="about" class="border-t border-white/10 mt-12">
        <div class="mx-auto max-w-7xl px-4 sm:px-6 lg:px-8 py-8 text-center text-sm text-secondary">
            <p>2022–2025 © SanchitFlix. Redesigned for a premium user experience.</p>
        </div>
    </footer>

    <!-- MODALS -->
    <div id="previewModal" class="modal-overlay hidden">
        <div class="modal-content">
            <button id="closeModal" class="modal-close h-10 w-10 grid place-items-center rounded-full hover:bg-white/10 active:scale-95 transition">
                <i class="fa-solid fa-xmark text-white/80 text-xl"></i>
            </button>
            <img id="previewImage" src="" alt="Full-size screenshot preview">
        </div>
    </div>

    <div id="redirectStatus" class="modal-overlay hidden">
        <div class="p-6 rounded-xl bg-surface border border-accent/30 shadow-accentGlow text-center max-w-xs mx-4">
            <i class="fa-solid fa-cloud-arrow-down fa-spin text-accent text-4xl"></i>
            <h3 class="text-xl font-bold mt-4 text-primary">Accessing Secure Link...</h3>
            <p class="text-secondary mt-1 text-sm">Please wait a moment...</p>
        </div>
    </div>

    <script>
        const API_URL = 'https://4khdhub.fans/';
        const DATA_API_URL = 'https://sanch1tx-flix.hf.space';

        // DOM Element selectors
        const qs = (sel, ctx = document) => ctx.querySelector(sel);
        const qsa = (sel, ctx = document) => Array.from(ctx.querySelectorAll(sel));

        const elements = {
            movieList: qs('#movie-list'),
            movieDetailsSection: qs('#movie-details-section'),
            results: qs('#results'), 
            backButton: null, // will be created dynamically
            resultMeta: qs('#resultMeta'),
            resultMetaContainer: qs('#resultMetaContainer'),
            toast: qs('#toast'),
            toastText: qs('#toastText'),
            paginationContainer: qs('#pagination-container'),
            searchInput: qs('#search-input'),
            searchButton: qs('#search-button'),
            mobileSearchButton: qs('#mobile-search-button'),
            quickChips: qs('#quickChips'),
            redirectStatus: qs('#redirectStatus'),
            previewModal: qs('#previewModal'),
            previewImage: qs('#previewImage'),
            closeModalButton: qs('#closeModal'),
        };

        let state = {
            currentPage: 1,
            maxPages: 5,
            isFetchingDetails: false,
            currentDetailsData: null,
            activeDownloadTab: 'zippack',
            currentQuery: '',
        };
        
        // --- UI Functions ---
        function showToast(text) {
            elements.toastText.textContent = text || 'Working…';
            elements.toast.classList.remove('hidden');
            clearTimeout(showToast._t);
            showToast._t = setTimeout(() => elements.toast.classList.add('hidden'), 2200);
        }

        function showSkeletons(count = 12) {
            elements.movieList.innerHTML = '';
            const tpl = qs('#card-skeleton').content;
            for (let i = 0; i < count; i++) {
                elements.movieList.appendChild(tpl.cloneNode(true));
            }
        }
        
        function createChip(text) {
            const btn = document.createElement('button');
            btn.className = 'bg-surface border border-white/10 text-xs px-3 py-1.5 rounded-full hover:border-accent/80 hover:text-primary transition';
            btn.textContent = text;
            btn.addEventListener('click', () => doSearch(text));
            return btn;
        }

        function movieCard({ title, imageUrl, link, quality }, i) {
            const a = document.createElement('a');
            a.href = '#';
            a.className = 'group relative overflow-hidden rounded-lg bg-surface border border-white/10 shadow-lg hover:shadow-accent/20 hover:-translate-y-1 transition-all duration-300';
            a.setAttribute('data-movie-url', link);
            a.style.animationDelay = `${i * 40}ms`;
            a.style.opacity = 0;
            a.classList.add('animate-fadeUp');

            a.innerHTML = `
                <div class="relative aspect-[2/3]">
                    <img data-src="${imageUrl}" alt="${title}" class="block w-full h-full object-cover" onerror="this.src='https://placehold.co/400x600/1F2937/9CA3AF?text=No+Poster'" />
                    <div class="absolute inset-0 bg-gradient-to-t from-black/70 via-black/20 to-transparent"></div>
                    ${quality ? `<span class="absolute top-2 right-2 text-xs font-bold bg-accent text-background px-2 py-0.5 rounded-full">${quality}</span>` : ''}
                </div>
                <div class="p-3">
                    <h3 class="font-semibold text-sm text-primary group-hover:text-accent-light transition-colors clamp-2">${title}</h3>
                </div>`;

            a.addEventListener('click', (e) => { e.preventDefault(); fetchMoviePage(link); });

            lazyObserver.observe(a.querySelector('img'));
            return a;
        }

        const lazyObserver = new IntersectionObserver((entries, observer) => {
            entries.forEach(entry => {
                if (entry.isIntersecting) {
                    const img = entry.target;
                    const src = img.dataset.src;
                    if (src) {
                        img.src = src;
                        img.removeAttribute('data-src');
                    }
                    observer.unobserve(img);
                }
            });
        }, { rootMargin: '200px' });

        // --- API & Data Handling ---
        async function fetchApi(endpoint, params = {}) {
            const url = new URL(`${DATA_API_URL}${endpoint}`);
            Object.entries(params).forEach(([key, value]) => url.searchParams.append(key, value));
            
            const response = await fetch(url);
            if (!response.ok) throw new Error(`API error: ${response.statusText}`);
            return response.json();
        }

        async function fetchMovies(page = 1, query = '') {
            try {
                elements.movieDetailsSection.classList.add('hidden');
                elements.movieList.classList.remove('hidden');
                elements.paginationContainer.classList.remove('hidden');
                
                state.currentQuery = query;
                state.currentPage = page;
                
                const activeQuery = state.currentQuery.trim();
                const title = activeQuery ? `Results for "${activeQuery}"` : 'Latest Releases';
                elements.resultMetaContainer.querySelector('h2').textContent = title;

                showToast(activeQuery ? `Searching for “${activeQuery}”...` : `Loading page ${page}...`);
                showSkeletons();
                
                let data;
                if (activeQuery) {
                    data = await fetchApi('/search', { query: activeQuery, page });
                } else {
                    data = await fetchApi(page === 1 ? '/home' : `/page/${page}`);
                }
                
                const movies = data.results.map(item => ({
                    title: item.title, imageUrl: item.poster, link: item.url, quality: item.quality
                }));
                
                renderResults(movies);
                renderPagination(state.currentPage, data.totalPages || state.maxPages, activeQuery);
            } catch (e) {
                console.error('fetchMovies Error:', e);
                elements.movieList.innerHTML = `<div class="col-span-full text-center text-red-400 py-16">Failed to load content. Please try again later.</div>`;
                elements.paginationContainer.innerHTML = '';
            }
        }
        
        async function fetchMoviePage(relativeUrl) {
            if (state.isFetchingDetails) return;
            state.isFetchingDetails = true;

            try {
                showToast('Loading details…');
                elements.movieList.classList.add('hidden');
                elements.paginationContainer.classList.add('hidden');
                elements.movieDetailsSection.innerHTML = '<div class="text-center py-20"><i class="fa-solid fa-spinner fa-spin text-4xl text-accent"></i></div>';
                elements.movieDetailsSection.classList.remove('hidden');

                const absoluteUrl = API_URL + relativeUrl;
                const details = await fetchApi('/details', { url: absoluteUrl });
                
                state.currentDetailsData = details;
                renderMovieDetails(details);
                
                window.scrollTo({ top: elements.results.offsetTop - 80, behavior: 'smooth' });
            } catch (e) {
                console.error('fetchMoviePage Error:', e);
                showToast('Failed to load details');
                elements.movieDetailsSection.innerHTML = `<div class="text-center text-red-400 py-16">Could not load details for this title.</div>`;
            } finally {
                state.isFetchingDetails = false;
            }
        }
        
        async function handleFinalDownload(url, button) {
            if (button) {
                button.disabled = true;
                button.dataset.originalHTML = button.innerHTML;
                button.innerHTML = `<i class="fa-solid fa-spinner fa-spin"></i>`;
            }
            elements.redirectStatus.classList.remove('hidden');

            try {
                const data = await fetchApi('/bypass', { url });
                if (data && data.final_url) {
                    showToast('Redirecting to download!');
                    setTimeout(() => window.location.href = data.final_url, 500);
                } else {
                    throw new Error(data.error || 'Could not get the final URL.');
                }
            } catch (error) {
                console.error('Bypass error:', error);
                showToast(`Error: ${error.message}`);
            } finally {
                elements.redirectStatus.classList.add('hidden');
                if (button) {
                    button.disabled = false;
                    button.innerHTML = button.dataset.originalHTML;
                }
            }
        }

        // --- Render Functions ---
        function renderResults(movies) {
            elements.movieList.innerHTML = '';
            if (!movies.length) {
                elements.movieList.innerHTML = `<div class="col-span-full text-center text-secondary py-16">No results found. Try a different search.</div>`;
                return;
            }
            movies.forEach((m, i) => elements.movieList.appendChild(movieCard(m, i)));
        }

        function renderMovieDetails(details) {
            // Main structure
            const detailsHTML = `
                <button id="back-button" class="mb-6 inline-flex items-center gap-2 bg-surface border border-white/10 px-4 h-11 rounded-full text-sm font-semibold hover:border-white/20 transition">
                    <i class="fa-solid fa-arrow-left"></i>
                    <span>Back to results</span>
                </button>
                <div class="bg-surface/50 border border-white/10 rounded-2xl">
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-6 lg:gap-8 p-4 sm:p-6 lg:p-8">
                        <div class="md:col-span-1">
                            <img src="${details.poster || 'https://placehold.co/800x1200/1F2937/9CA3AF?text=No+Image'}" class="w-full h-auto rounded-lg object-cover shadow-lg" alt="Poster for ${details.title}">
                        </div>
                        <div class="md:col-span-2 space-y-5">
                            <div>
                                <h3 class="text-2xl sm:text-3xl lg:text-4xl font-bold tracking-tight">${details.title || 'Untitled'}</h3>
                                <div class="flex flex-wrap items-center gap-x-4 gap-y-2 mt-3 text-secondary text-sm">
                                    ${details.metadata.imdb ? `<span class="inline-flex items-center gap-1.5"><i class="fa-solid fa-star text-yellow-400"></i> ${details.metadata.imdb}</span>` : ''}
                                    ${details.metadata.release ? `<span>${details.metadata.release}</span>` : ''}
                                    ${details.metadata.runtime ? `<span>${details.metadata.runtime}</span>` : ''}
                                </div>
                            </div>
                            <p class="text-secondary text-base leading-relaxed">${details.summary || 'No storyline available.'}</p>
                            
                            <!-- Key-Value Metadata -->
                            <div id="metadata-wrap" class="grid grid-cols-2 gap-x-4 gap-y-2 pt-2 text-sm"></div>

                            <!-- Watch Online -->
                            <div id="watch-online-wrap"></div>
                        </div>
                    </div>
                </div>

                <!-- Downloads & Screenshots in separate cards below -->
                <div class="mt-6 space-y-6">
                    <div id="downloads-container"></div>
                    <div id="screenshots-container"></div>
                </div>
            `;
            elements.movieDetailsSection.innerHTML = detailsHTML;
            elements.backButton = qs('#back-button');
            elements.backButton.addEventListener('click', backToResults);

            // Populate metadata
            const metadataWrap = qs('#metadata-wrap');
            const metaToDisplay = { Genre: details.metadata.genre, Director: details.metadata.director, Cast: details.metadata.cast, Quality: details.metadata.quality };
            metadataWrap.innerHTML = Object.entries(metaToDisplay).map(([key, value]) => {
                return value ? `<div class="truncate"><span class="text-secondary">${key}:</span> <span class="text-primary font-medium">${value}</span></div>` : '';
            }).join('');
            
            // Watch Online Button
            const watchWrap = qs('#watch-online-wrap');
            if (details.metadata.watch) {
                watchWrap.innerHTML = `<a href="${details.metadata.watch}" target="_blank" rel="noopener" class="inline-flex items-center gap-2 accent-btn text-background px-5 py-2.5 rounded-full font-bold transition">
                    <i class="fa-solid fa-play"></i><span>Watch Trailer</span></a>`;
            }

            renderDownloadsSection(details.download_options);
            renderScreenshotsSection(details.screenshots);
        }

        function renderDownloadsSection(download_options) {
            const container = qs('#downloads-container');
            const { movie_files, season_packs, individual_episodes } = download_options;
            const hasMovieFiles = movie_files.length > 0;
            const hasSeasonPacks = season_packs.length > 0;
            const hasIndividualEpisodes = individual_episodes?.some(s => s.episodes?.length > 0);

            if (!hasMovieFiles && !hasSeasonPacks && !hasIndividualEpisodes) return;

            state.activeDownloadTab = (hasMovieFiles || hasSeasonPacks) ? 'zippack' : 'singleeps';
            
            let tabsHTML = '';
            if (hasMovieFiles || hasSeasonPacks) {
                tabsHTML += `<button data-tab="zippack" class="tab-button">Zip / Pack</button>`;
            }
            if (hasIndividualEpisodes) {
                tabsHTML += `<button data-tab="singleeps" class="tab-button">Single Episodes</button>`;
            }

            container.innerHTML = `
                <div class="bg-surface/50 border border-white/10 rounded-2xl p-4 sm:p-6">
                    <h4 class="text-xl font-bold mb-4">Download Links</h4>
                    <div class="border-b border-white/10 mb-4 flex gap-4">${tabsHTML}</div>
                    <div id="downloadWrap" class="space-y-3"></div>
                </div>`;
            
            qsa('.tab-button', container).forEach(btn => btn.addEventListener('click', (e) => {
                setActiveDownloadTab(e.target.dataset.tab, container);
            }));
            
            setActiveDownloadTab(state.activeDownloadTab, container);
        }

        function renderScreenshotsSection(screenshots) {
            if (!screenshots || screenshots.length === 0) return;
            const container = qs('#screenshots-container');
            container.innerHTML = `
                <div class="bg-surface/50 border border-white/10 rounded-2xl p-4 sm:p-6">
                    <h4 class="text-xl font-bold mb-4">Screenshots</h4>
                    <div id="screensWrap" class="grid grid-cols-2 sm:grid-cols-3 gap-3">
                        ${screenshots.map(src => `
                            <a href="${src}" class="block relative overflow-hidden rounded-lg border border-white/10 cursor-pointer group aspect-video">
                                <img src="${src}" alt="Screenshot" class="w-full h-full object-cover group-hover:scale-105 transition-transform duration-300" />
                                <div class="absolute inset-0 bg-black/50 grid place-items-center opacity-0 group-hover:opacity-100 transition-opacity">
                                    <i class="fa-solid fa-magnifying-glass-plus text-white text-2xl"></i>
                                </div>
                            </a>`).join('')}
                    </div>
                </div>`;

            qsa('#screensWrap a', container).forEach(a => a.addEventListener('click', (e) => {
                e.preventDefault();
                elements.previewImage.src = a.href;
                elements.previewModal.classList.remove('hidden');
            }));
        }
        
        function renderDownloadLinks() {
            const downloadWrap = qs('#downloadWrap');
            if (!downloadWrap || !state.currentDetailsData) return;
            
            downloadWrap.innerHTML = '';
            const { movie_files, season_packs, individual_episodes } = state.currentDetailsData.download_options;

            const createLinkCard = (item, index) => {
                const links = item.downloads?.filter(l => !l.provider.toLowerCase().includes('direct link')) || [];
                if (links.length === 0) return '';
                
                let titleText = item.quality_description || item.season_title || item.episode_title || 'File';
                // This condition now only runs when an index is explicitly passed (for single episodes)
                if (typeof index === 'number') {
                    titleText = `Episode ${index + 1}`;
                }
                
                return `
                    <div class="bg-background/40 p-3 rounded-lg border border-white/10">
                        <div class="flex justify-between items-center">
                            <span class="font-semibold text-primary text-base">${titleText}</span>
                            <span class="text-xs text-secondary">${item.size || ''}</span>
                        </div>
                        <div class="flex flex-wrap gap-2 pt-3">
                            ${links.map(l => {
                                const lower = l.provider.toLowerCase();
                                let icon = 'fa-cloud-arrow-down';
                                if (lower.includes('drive')) icon = 'fa-brands fa-google-drive';
                                else if (lower.includes('cloud')) icon = 'fa-cloud';
                                else if (lower.includes('batch') || lower.includes('zip')) icon = 'fa-file-zipper';
                                return `<button data-url="${l.url}" class="final-link-btn inline-flex items-center gap-2 bg-secondary/10 text-secondary text-sm font-medium px-3 py-1.5 rounded-md hover:bg-secondary/20 hover:text-primary transition">
                                    <i class="fa-solid ${icon} fa-fw"></i> ${l.provider}
                                </button>`;
                            }).join('')}
                        </div>
                    </div>`;
            };

            let contentHTML = '';
            if (state.activeDownloadTab === 'zippack') {
                // We call createLinkCard without the index for zip/packs
                contentHTML += movie_files.map(item => createLinkCard(item)).join('');
                contentHTML += season_packs.map(item => createLinkCard(item)).join('');
            } else {
                individual_episodes.forEach(season => {
                    contentHTML += `<h5 class="text-primary font-bold pt-3 pb-1">${season.season_title}</h5>`;
                    // We pass the index only for single episodes
                    contentHTML += season.episodes.map((episode, index) => createLinkCard(episode, index)).join('');
                });
            }

            if (!contentHTML) {
                downloadWrap.innerHTML = `<div class="text-sm text-secondary p-4 text-center">No downloads available for this category.</div>`;
            } else {
                downloadWrap.innerHTML = contentHTML;
            }

            qsa('.final-link-btn', downloadWrap).forEach(btn => btn.addEventListener('click', (e) => {
                handleFinalDownload(e.currentTarget.dataset.url, e.currentTarget);
            }));
        }

        function renderPagination(current, total, query) {
            const container = elements.paginationContainer;
            container.innerHTML = '';
            if (total <= 1) return;

            const createBtn = (page, text, icon = '') => {
                const btn = document.createElement('button');
                btn.className = 'bg-surface border border-white/10 h-10 px-4 rounded-lg text-sm font-semibold hover:border-white/20 transition disabled:opacity-50 disabled:cursor-not-allowed';
                btn.innerHTML = icon ? `<i class="fa-solid ${icon}"></i>` : (text || page);
                if (typeof page === 'number') btn.addEventListener('click', () => fetchMovies(page, query));
                if (page === '...') btn.disabled = true;
                if (page === current) btn.classList.add('!bg-accent', '!text-background', '!border-accent');
                return btn;
            };

            container.appendChild(createBtn(current - 1, null, 'fa-arrow-left')).disabled = current <= 1;

            const pages = getPaginationRange(current, total);
            pages.forEach(p => container.appendChild(createBtn(p)));

            container.appendChild(createBtn(current + 1, null, 'fa-arrow-right')).disabled = current >= total;
        }

        function getPaginationRange(current, total, width = 2) {
            if (total <= (width * 2) + 3) {
                return [...Array(total).keys()].map(i => i + 1);
            }
            const range = [];
            range.push(1);
            if (current > width + 2) range.push('...');
            for (let i = Math.max(2, current - width); i <= Math.min(total - 1, current + width); i++) {
                range.push(i);
            }
            if (current < total - (width + 1)) range.push('...');
            range.push(total);
            return range;
        }

        // --- Event Handlers & Initializers ---
        function doSearch(query) {
            const trimmedQuery = query.trim();
            elements.searchInput.value = trimmedQuery;
            fetchMovies(1, trimmedQuery);
        }
        
        function backToResults() {
            elements.movieDetailsSection.classList.add('hidden');
            elements.movieList.classList.remove('hidden');
            elements.paginationContainer.classList.remove('hidden');
            elements.resultMetaContainer.querySelector('h2').textContent = state.currentQuery ? `Results for "${state.currentQuery}"` : 'Latest Releases';
        }

        function setActiveDownloadTab(tabName, context) {
            state.activeDownloadTab = tabName;
            qsa('.tab-button', context).forEach(btn => {
                btn.classList.toggle('active', btn.dataset.tab === tabName);
            });
            renderDownloadLinks();
        }

        function initialize() {
            if ('serviceWorker' in navigator) {
                navigator.serviceWorker.register('/sw.js')
                    .then(reg => console.log('Service Worker Registered', reg))
                    .catch(err => console.error('SW Error', err));
            }

            const defaultChips = ['Inception', 'Breaking Bad', 'Oppenheimer', 'Stranger Things', 'Joker'];
            defaultChips.forEach(c => elements.quickChips.appendChild(createChip(c)));
            
            elements.searchButton.addEventListener('click', () => doSearch(elements.searchInput.value));
            elements.searchInput.addEventListener('keydown', (e) => { if (e.key === 'Enter') doSearch(elements.searchInput.value); });
            
            elements.mobileSearchButton.addEventListener('click', () => {
                elements.searchInput.focus();
                window.scrollTo({
                    top: elements.searchInput.getBoundingClientRect().top + window.scrollY - 80, // 80px offset
                    behavior: 'smooth'
                });
            });

            elements.closeModalButton.addEventListener('click', () => elements.previewModal.classList.add('hidden'));
            elements.previewModal.addEventListener('click', (e) => {
                if (e.target.id === 'previewModal') elements.previewModal.classList.add('hidden');
            });
            
            fetchMovies(1); // Initial load
        }

        window.addEventListener('load', initialize);
    </script>
</body>
</html>

